<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Sync Test - TrailVerse</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-badge.connected {
            background: #10b981;
            color: white;
        }
        
        .status-badge.disconnected {
            background: #ef4444;
            color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f3f4f6;
            margin-bottom: 8px;
            border-radius: 5px;
        }
        
        .info-label {
            font-weight: 600;
            color: #6b7280;
        }
        
        .info-value {
            color: #1f2937;
        }
        
        .log-container {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #374151;
        }
        
        .log-entry.event {
            color: #10b981;
        }
        
        .log-entry.error {
            color: #ef4444;
        }
        
        .log-entry.info {
            color: #60a5fa;
        }
        
        .timestamp {
            color: #9ca3af;
            margin-right: 10px;
        }
        
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .instructions {
            background: #fef3c7;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #f59e0b;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            color: #92400e;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
            color: #78350f;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ Real-Time Sync Test - TrailVerse</h1>
            <p>Test multi-device synchronization with WebSocket</p>
            <div style="margin-top: 10px;">
                <span id="status-badge" class="status-badge disconnected">Disconnected</span>
                <span id="socket-id" style="margin-left: 10px; color: #6b7280;">Socket ID: None</span>
            </div>
        </div>

        <div class="instructions">
            <h3>üìã Testing Instructions</h3>
            <ol>
                <li>Login with your credentials below</li>
                <li>Open this page in multiple browser tabs or devices</li>
                <li>Login with the same account on all tabs/devices</li>
                <li>Use the test buttons to trigger events</li>
                <li>Watch the logs to see real-time updates across all tabs/devices</li>
            </ol>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üîê Authentication</h2>
                <div class="input-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="your.email@example.com">
                </div>
                <div class="input-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button onclick="login()">Login</button>
                <button onclick="logout()" style="background: #ef4444; margin-left: 10px;">Logout</button>
            </div>

            <div class="card">
                <h2>üìä Connection Status</h2>
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span class="info-value" id="connection-status">Disconnected</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Socket ID:</span>
                    <span class="info-value" id="connection-socket-id">None</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Reconnect Attempts:</span>
                    <span class="info-value" id="reconnect-attempts">0</span>
                </div>
                <div class="info-row">
                    <span class="info-label">User ID:</span>
                    <span class="info-value" id="user-id">Not logged in</span>
                </div>
            </div>

            <div class="card">
                <h2>üß™ Test Actions</h2>
                <div class="test-controls">
                    <button onclick="testFavoriteAdd()" id="test-favorite-btn">Add Test Favorite</button>
                    <button onclick="testFavoriteRemove()" id="test-favorite-remove-btn">Remove Test Favorite</button>
                    <button onclick="subscribeToFavorites()">Subscribe to Favorites</button>
                    <button onclick="clearLogs()">Clear Logs</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìù Event Logs (Real-Time)</h2>
            <div class="log-container" id="log-container">
                <div class="log-entry info">
                    <span class="timestamp">[00:00:00]</span>
                    <span>Ready to test. Please login first.</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let socket = null;
        let token = null;
        let userId = null;
        let testFavoriteId = null;

        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5001' 
            : 'https://www.nationalparksexplorerusa.com';

        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const now = new Date();
            const timestamp = now.toTimeString().split(' ')[0];
            
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span><span>${message}</span>`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function updateStatus(connected) {
            const badge = document.getElementById('status-badge');
            const status = document.getElementById('connection-status');
            
            if (connected) {
                badge.textContent = 'Connected';
                badge.className = 'status-badge connected';
                status.textContent = 'Connected';
            } else {
                badge.textContent = 'Disconnected';
                badge.className = 'status-badge disconnected';
                status.textContent = 'Disconnected';
            }
        }

        function updateSocketId(id) {
            document.getElementById('socket-id').textContent = `Socket ID: ${id || 'None'}`;
            document.getElementById('connection-socket-id').textContent = id || 'None';
        }

        function updateReconnectAttempts(attempts) {
            document.getElementById('reconnect-attempts').textContent = attempts;
        }

        function connectWebSocket() {
            if (!token) {
                log('No token available. Please login first.', 'error');
                return;
            }

            log('Connecting to WebSocket...', 'info');

            socket = io(API_URL, {
                auth: { token },
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                reconnectionAttempts: 5,
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                log('‚úÖ WebSocket connected!', 'event');
                updateStatus(true);
                updateSocketId(socket.id);
                socket.emit('authenticate', { token });
            });

            socket.on('authenticated', (data) => {
                log(`üîê Authenticated! User ID: ${data.userId}`, 'event');
                userId = data.userId;
                document.getElementById('user-id').textContent = data.userId;
            });

            socket.on('auth_error', (data) => {
                log(`‚ùå Authentication error: ${data.message}`, 'error');
            });

            socket.on('disconnect', (reason) => {
                log(`‚ö†Ô∏è Disconnected: ${reason}`, 'error');
                updateStatus(false);
                updateSocketId(null);
            });

            socket.on('connect_error', (error) => {
                log(`‚ùå Connection error: ${error.message}`, 'error');
            });

            socket.on('reconnect_attempt', (attemptNumber) => {
                log(`üîÑ Reconnection attempt ${attemptNumber}`, 'info');
                updateReconnectAttempts(attemptNumber);
            });

            socket.on('reconnect', (attemptNumber) => {
                log(`‚úÖ Reconnected after ${attemptNumber} attempts`, 'event');
                updateReconnectAttempts(0);
            });

            // Listen for real-time data updates
            socket.on('favorite_added', (data) => {
                log(`‚≠ê [REAL-TIME] Favorite added: ${JSON.stringify(data)}`, 'event');
            });

            socket.on('favorite_removed', (data) => {
                log(`üóëÔ∏è [REAL-TIME] Favorite removed: ${JSON.stringify(data)}`, 'event');
            });

            socket.on('trip_created', (data) => {
                log(`üó∫Ô∏è [REAL-TIME] Trip created: ${JSON.stringify(data)}`, 'event');
            });

            socket.on('trip_updated', (data) => {
                log(`üìù [REAL-TIME] Trip updated: ${JSON.stringify(data)}`, 'event');
            });

            socket.on('trip_deleted', (data) => {
                log(`üóëÔ∏è [REAL-TIME] Trip deleted: ${JSON.stringify(data)}`, 'event');
            });

            socket.on('review_added', (data) => {
                log(`üí¨ [REAL-TIME] Review added: ${JSON.stringify(data)}`, 'event');
            });

            socket.on('review_updated', (data) => {
                log(`‚úèÔ∏è [REAL-TIME] Review updated: ${JSON.stringify(data)}`, 'event');
            });

            socket.on('preferences_updated', (data) => {
                log(`‚öôÔ∏è [REAL-TIME] Preferences updated: ${JSON.stringify(data)}`, 'event');
            });
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }

            log(`Attempting to login as ${email}...`, 'info');

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    token = data.token;
                    log(`‚úÖ Login successful!`, 'event');
                    connectWebSocket();
                } else {
                    log(`‚ùå Login failed: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Login error: ${error.message}`, 'error');
            }
        }

        function logout() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            token = null;
            userId = null;
            testFavoriteId = null;
            updateStatus(false);
            updateSocketId(null);
            document.getElementById('user-id').textContent = 'Not logged in';
            log('üö™ Logged out', 'info');
        }

        function subscribeToFavorites() {
            if (socket && socket.connected) {
                socket.emit('subscribe', { channel: 'favorites' });
                log('üì° Subscribed to favorites channel', 'info');
            } else {
                log('‚ùå Not connected. Please login first.', 'error');
            }
        }

        async function testFavoriteAdd() {
            if (!token) {
                log('‚ùå Please login first', 'error');
                return;
            }

            log('Adding test favorite...', 'info');

            try {
                const response = await fetch(`${API_URL}/api/favorites`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        parkCode: 'test-' + Date.now(),
                        parkName: 'Test Park - WebSocket Sync',
                        imageUrl: 'https://via.placeholder.com/300',
                        notes: 'This is a test favorite for WebSocket sync',
                        visitStatus: 'want-to-visit'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    testFavoriteId = data.data._id;
                    log(`‚úÖ Test favorite added! ID: ${testFavoriteId}`, 'event');
                    log('üëÄ Check other tabs/devices for real-time update!', 'info');
                } else {
                    log(`‚ùå Failed to add favorite: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error adding favorite: ${error.message}`, 'error');
            }
        }

        async function testFavoriteRemove() {
            if (!token) {
                log('‚ùå Please login first', 'error');
                return;
            }

            if (!testFavoriteId) {
                log('‚ùå No test favorite to remove. Add one first.', 'error');
                return;
            }

            log('Removing test favorite...', 'info');

            try {
                // First get the parkCode from the favorite
                const getFavorite = await fetch(`${API_URL}/api/favorites/user/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const favoritesData = await getFavorite.json();
                const testFavorite = favoritesData.data.find(f => f._id === testFavoriteId);

                if (!testFavorite) {
                    log('‚ùå Test favorite not found', 'error');
                    return;
                }

                const response = await fetch(`${API_URL}/api/favorites/${testFavorite.parkCode}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    log(`‚úÖ Test favorite removed!`, 'event');
                    log('üëÄ Check other tabs/devices for real-time update!', 'info');
                    testFavoriteId = null;
                } else {
                    log(`‚ùå Failed to remove favorite: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error removing favorite: ${error.message}`, 'error');
            }
        }

        function clearLogs() {
            const container = document.getElementById('log-container');
            container.innerHTML = '<div class="log-entry info"><span class="timestamp">[' + 
                new Date().toTimeString().split(' ')[0] + 
                ']</span><span>Logs cleared.</span></div>';
        }

        // Initialize
        log('üöÄ Test page loaded. Ready to test real-time sync!', 'info');
        log('üìå Open this page in multiple tabs to test multi-device sync.', 'info');
    </script>
</body>
</html>

